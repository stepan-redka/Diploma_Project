@{
    ViewData["Title"] = "Database Management";
}

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="display-6">
                        <i class="bi bi-database"></i> Database Management
                    </h1>
                    <p class="text-muted mb-0">View, manage, and delete stored document chunks</p>
                </div>
                <div class="btn-group">
                    <button class="btn btn-outline-secondary" onclick="refreshChunks()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                    <button class="btn btn-outline-danger" onclick="clearDatabase()">
                        <i class="bi bi-trash"></i> Clear All
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body py-3">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <span class="text-muted">Status:</span>
                            <span id="status-indicator" class="badge bg-secondary ms-1">Checking...</span>
                        </div>
                        <div class="col-auto">
                            <span class="text-muted">Total Chunks:</span>
                            <strong id="total-chunks" class="ms-1">0</strong>
                        </div>
                        <div class="col-auto">
                            <span class="text-muted">Documents:</span>
                            <strong id="total-documents" class="ms-1">0</strong>
                        </div>
                        <div class="col-auto ms-auto" id="selection-info" style="display: none;">
                            <span class="badge bg-primary">
                                <span id="selected-count">0</span> selected
                            </span>
                            <button class="btn btn-sm btn-danger ms-2" onclick="deleteSelectedChunks()">
                                <i class="bi bi-trash"></i> Delete Selected
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Controls -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-end">
                <div class="input-group" style="max-width: 300px;">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control form-control-sm" id="search-input" 
                           placeholder="Filter chunks..." oninput="filterChunks()">
                </div>
            </div>
        </div>
    </div>

    <!-- Chunks Container -->
    <div class="row">
        <div class="col-12">
            <div id="chunks-container">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="text-muted mt-2">Loading chunks...</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let allChunks = [];
        let groupedChunks = {};

        document.addEventListener('DOMContentLoaded', () => {
            checkStatus();
            refreshChunks();
        });

        async function checkStatus() {
            try {
                const response = await fetch('/Database/Status');
                const data = await response.json();
                const indicator = document.getElementById('status-indicator');
                indicator.className = data.status === 'ready' ? 'badge bg-success ms-1' : 'badge bg-danger ms-1';
                indicator.textContent = data.status === 'ready' ? 'Connected' : 'Error';
            } catch {
                document.getElementById('status-indicator').className = 'badge bg-danger ms-1';
                document.getElementById('status-indicator').textContent = 'Disconnected';
            }
        }

        async function refreshChunks() {
            const container = document.getElementById('chunks-container');
            container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><p class="text-muted mt-2">Loading...</p></div>';

            try {
                const response = await fetch('/Database/ViewChunks?limit=500');
                const data = await response.json();
                
                allChunks = data.chunks;
                document.getElementById('total-chunks').textContent = data.count;
                
                groupedChunks = {};
                allChunks.forEach(c => {
                    if (!groupedChunks[c.sourceDocument]) groupedChunks[c.sourceDocument] = [];
                    groupedChunks[c.sourceDocument].push(c);
                });
                
                document.getElementById('total-documents').textContent = Object.keys(groupedChunks).length;
                renderChunks();
            } catch (error) {
                container.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }

        function renderChunks(filter = '') {
            const container = document.getElementById('chunks-container');
            
            if (allChunks.length === 0) {
                container.innerHTML = '<div class="alert alert-info"><i class="bi bi-info-circle"></i> No chunks stored. <a href="/">Go to Home</a> to ingest documents.</div>';
                return;
            }

            let html = '';
            const filterLower = filter.toLowerCase();
            
            for (const [source, chunks] of Object.entries(groupedChunks)) {
                const filteredChunks = filter 
                    ? chunks.filter(c => c.contentPreview.toLowerCase().includes(filterLower) || source.toLowerCase().includes(filterLower))
                    : chunks;
                
                if (filteredChunks.length === 0) continue;
                
                html += `
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <input type="checkbox" class="form-check-input me-3 source-checkbox" 
                                           data-source="${source}" onchange="toggleSourceChunks('${source}', this.checked)">
                                    <div>
                                        <h6 class="mb-0"><i class="bi bi-file-earmark-text"></i> ${escapeHtml(source)}</h6>
                                        <small class="text-muted">${chunks.length} chunks</small>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteSourceChunks('${source}')">
                                    <i class="bi bi-trash"></i> Delete All
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 40px;"></th>
                                        <th style="width: 80px;">Chunk</th>
                                        <th>Content Preview</th>
                                        <th style="width: 60px;"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${filteredChunks.map(c => `
                                        <tr>
                                            <td><input type="checkbox" class="form-check-input chunk-checkbox" data-id="${c.id}" data-source="${source}" onchange="updateSelection()"></td>
                                            <td><span class="badge bg-secondary">#${c.chunkIndex}</span></td>
                                            <td><small class="text-break">${escapeHtml(c.contentPreview)}</small></td>
                                            <td><button class="btn btn-sm btn-link text-danger p-0" onclick="deleteChunk('${c.id}')"><i class="bi bi-trash"></i></button></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
            }
            
            container.innerHTML = html || '<div class="alert alert-warning"><i class="bi bi-search"></i> No chunks match your filter.</div>';
            updateSelection();
        }

        function filterChunks() {
            renderChunks(document.getElementById('search-input').value);
        }

        function updateSelection() {
            const checked = document.querySelectorAll('.chunk-checkbox:checked');
            document.getElementById('selected-count').textContent = checked.length;
            document.getElementById('selection-info').style.display = checked.length > 0 ? 'block' : 'none';
            
            for (const source of Object.keys(groupedChunks)) {
                const sourceBox = document.querySelector(`.source-checkbox[data-source="${source}"]`);
                const all = document.querySelectorAll(`.chunk-checkbox[data-source="${source}"]`);
                const checkedInSource = document.querySelectorAll(`.chunk-checkbox[data-source="${source}"]:checked`);
                if (sourceBox) {
                    sourceBox.checked = checkedInSource.length === all.length && all.length > 0;
                    sourceBox.indeterminate = checkedInSource.length > 0 && checkedInSource.length < all.length;
                }
            }
        }

        function selectAllChunks() {
            document.querySelectorAll('.chunk-checkbox, .source-checkbox').forEach(cb => cb.checked = true);
            updateSelection();
        }

        function deselectAllChunks() {
            document.querySelectorAll('.chunk-checkbox, .source-checkbox').forEach(cb => { cb.checked = false; cb.indeterminate = false; });
            updateSelection();
        }

        function toggleSourceChunks(source, checked) {
            document.querySelectorAll(`.chunk-checkbox[data-source="${source}"]`).forEach(cb => cb.checked = checked);
            updateSelection();
        }

        async function deleteChunk(id) {
            if (!confirm('Delete this chunk?')) return;
            await performDelete([id]);
        }

        async function deleteSelectedChunks() {
            const ids = Array.from(document.querySelectorAll('.chunk-checkbox:checked')).map(cb => cb.dataset.id);
            if (ids.length === 0 || !confirm(`Delete ${ids.length} chunk(s)?`)) return;
            await performDelete(ids);
        }

        async function deleteSourceChunks(source) {
            const ids = groupedChunks[source]?.map(c => c.id) || [];
            if (ids.length === 0 || !confirm(`Delete all ${ids.length} chunks from "${source}"?`)) return;
            await performDelete(ids);
        }

        async function performDelete(ids) {
            try {
                const response = await fetch('/Database/DeleteChunks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chunkIds: ids })
                });
                const data = await response.json();
                alert(data.success ? '✅ ' + data.message : '❌ ' + data.message);
                if (data.success) refreshChunks();
            } catch (error) {
                alert('❌ Error: ' + error.message);
            }
        }

        async function clearDatabase() {
            if (!confirm('⚠️ DELETE ALL chunks? This cannot be undone!')) return;
            try {
                const response = await fetch('/Database/ClearDatabase', { method: 'POST' });
                const data = await response.json();
                alert(data.success ? '✅ ' + data.message : '❌ ' + data.message);
                if (data.success) refreshChunks();
            } catch (error) {
                alert('❌ Error: ' + error.message);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
}
